<div class="ai-assist-container">
  <!-- Welcome Screen (when no messages) -->
  <div class="welcome-screen" *ngIf="messages.length === 0">
    <div class="welcome-content">
      <div class="ai-logo">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
          <path d="M9.663 17H7.637C7.293 17 7.017 16.672 7.017 16.267V13.267C7.017 12.862 7.293 12.533 7.637 12.533H9.663C10.007 12.533 10.283 12.862 10.283 13.267V16.267C10.283 16.672 10.007 17 9.663 17Z" fill="currentColor"/>
          <path d="M16.363 17H14.337C13.993 17 13.717 16.672 13.717 16.267V10.267C13.717 9.862 13.993 9.533 14.337 9.533H16.363C16.707 9.533 16.983 9.862 16.983 10.267V16.267C16.983 16.672 16.707 17 16.363 17Z" fill="currentColor"/>
          <path d="M3.5 2V22H20.5V2H3.5ZM19.5 21H4.5V3H19.5V21Z" fill="currentColor"/>
        </svg>
      </div>
      <h2>Good evening! How can I assist you today?</h2>
      <p>I'm your personalized wealth advisor for Singapore-based professionals. Let's optimize your S$1.5M portfolio and plan your travel-focused retirement.</p>
      
      <!-- Suggested Questions -->
      <div class="suggested-questions">
        <div class="questions-header">
          <span class="questions-title">{{currentQuestionSet.title}}</span>
          <button class="refresh-btn" (click)="refreshQuestions()" title="Change questions">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" [class.spinning]="isRefreshing">
              <path d="M1 4V10H7M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15A9 9 0 0 0 18.36 18.36L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Change</span>
          </button>
        </div>
        <button class="suggestion-chip" *ngFor="let suggestion of currentQuestionSet.questions" (click)="selectSuggestion(suggestion)">
          {{suggestion}}
        </button>
      </div>
    </div>
  </div>

  <!-- Chat Messages -->
  <div class="chat-messages" #chatMessages *ngIf="messages.length > 0">
    <div *ngFor="let message of messages; let i = index" class="message-wrapper">
      
      <!-- Status Message -->
      <div *ngIf="message.type === 'status'" class="status-message">
        <div class="status-container">
          <div class="ai-thinking">
            <div class="thinking-avatar">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M9.663 17H7.637C7.293 17 7.017 16.672 7.017 16.267V13.267C7.017 12.862 7.293 12.533 7.637 12.533H9.663C10.007 12.533 10.283 12.862 10.283 13.267V16.267C10.283 16.672 10.007 17 9.663 17Z" fill="currentColor"/>
                <path d="M16.363 17H14.337C13.993 17 13.717 16.672 13.717 16.267V10.267C13.717 9.862 13.993 9.533 14.337 9.533H16.363C16.707 9.533 16.983 9.862 16.983 10.267V16.267C16.983 16.672 16.707 17 16.363 17Z" fill="currentColor"/>
                <path d="M3.5 2V22H20.5V2H3.5ZM19.5 21H4.5V3H19.5V21Z" fill="currentColor"/>
              </svg>
            </div>
            <div class="processing-steps">
              <div *ngFor="let status of processingStatuses; let j = index" 
                   class="processing-step"
                   [class.completed]="status.completed"
                   [class.current]="j === currentProcessingStep - 1 && !status.completed">
                <div class="step-icon">
                  <svg *ngIf="status.completed" width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon">
                    <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <div *ngIf="!status.completed && j === currentProcessingStep - 1" class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
                <span class="step-text">{{status.text}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Regular Messages -->
      <div *ngIf="message.type !== 'status'" class="message" [ngClass]="message.type + '-message'">
        <div class="message-avatar" *ngIf="message.type === 'assistant'">
          <div class="avatar ai-avatar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M9.663 17H7.637C7.293 17 7.017 16.672 7.017 16.267V13.267C7.017 12.862 7.293 12.533 7.637 12.533H9.663C10.007 12.533 10.283 12.862 10.283 13.267V16.267C10.283 16.672 10.007 17 9.663 17Z" fill="currentColor"/>
              <path d="M16.363 17H14.337C13.993 17 13.717 16.672 13.717 16.267V10.267C13.717 9.862 13.993 9.533 14.337 9.533H16.363C16.707 9.533 16.983 9.862 16.983 10.267V16.267C16.983 16.672 16.707 17 16.363 17Z" fill="currentColor"/>
              <path d="M3.5 2V22H20.5V2H3.5ZM19.5 21H4.5V3H19.5V21Z" fill="currentColor"/>
            </svg>
          </div>
        </div>
        
        <div class="message-content">
          <div class="message-text" [innerHTML]="formatMessage(message.content)">
            <div *ngIf="message.type === 'assistant' && !message.isComplete" class="typing-cursor">|</div>
          </div>
          <div class="message-meta">
            <span class="message-time">{{formatTime(message.timestamp)}}</span>
            <div class="message-actions" *ngIf="message.type === 'assistant' && message.isComplete">
              <button class="action-btn copy-btn" (click)="copyMessage(message.content)" title="Copy">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                  <path d="M16 4H18C19.1046 4 20 4.89543 20 6V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6C4 4.89543 4.89543 4 6 4H8" stroke="currentColor" stroke-width="2"/>
                  <rect x="8" y="2" width="8" height="4" rx="1" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
              <button class="action-btn thumbs-btn" title="Good response">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                  <path d="M7 10V20H21V10H7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M7 10L12 5L13 5C13.5523 5 14 5.44772 14 6V9H20L21 10V19L20 20H8L7 19V10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Container -->
  <div class="input-container">
    <div class="input-wrapper">
      <div class="input-field">
        <textarea 
          [(ngModel)]="currentMessage" 
          (keydown)="onKeyDown($event)"
          (input)="onInput($event)"
          placeholder="Ask me anything..."
          class="message-input"
          rows="1"
          #messageInput
        ></textarea>
        <button 
          (click)="sendMessage()" 
          class="send-btn" 
          [disabled]="!currentMessage.trim() || isTyping || isProcessing || isWritingResponse"
          [class.has-content]="currentMessage.trim()"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>
